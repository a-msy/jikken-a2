32ビットマイクロプロセッサp32マルチサイクルバージョン p32m2
---

### (配布ファイル)

| ファイル名               | 説明                                      |
|:-------------------------|:------------------------------------------|
| `p32m2.fsl`              | p32m2プロセッサモジュールFSL記述（雛形）  |
| `p32Opcode.fsl`          | 操作コード等の定義                        |
| `p32ExceptionCauseCode.fsl` | 例外原因コードの定義                   |
| `test_p32m2.fsl`         | テストベンチFSL記述                       |
| `sum10.s`                | 動作確認用のサンプルコード                |
| `makeMem.sh`             | テスト用メモリイメージを生成するプログラム |
| `test_p32m2.result.sample` | シミュレーション結果比較用のファイル    |
| `Makefile`               | Makefile                                  |
| `README.md`              | このファイル                              |
| `test/Makefile`          | 追加テスト用のMakefile                    |
| `test/*.s`               | 追加のサンプルコード                      |
| `test/*.result.sample`   | 追加のシミュレーション結果比較用ファイル  |



### サブモジュールのFSL記述ファイルについて

`p32m2.fsl` で用いるサブモジュールやそれ以下の階層で用いているモジュールの
FSL記述ファイル（例えば，p32DecoeUnitやp32ExecUnitの記述ファイルなど）は
このディレクトリにコピーしておく．
また，`Makefile` の下記の行に必要なFSL記述のファイルを書いておく

    # 各自のモジュール構成に合わせて必要なFSL記述ファイルを下記の行に書く
    SRCS    = p32ExceptionCauseCode.fsl p32Opcode.fsl alu32.fsl p32ExecUnit.fsl \
              regs32x8.fsl add32.fsl p32DecodeUnit.fsl regs32x32.fsl shift32.fsl \
              p32m2.fsl test_p32m2.fsl



### make の機能（コンパイル）

1. FSL記述を作成，編集し，`make` でコンパイル（エラーチェック）
2. `make verilog` でコンパイルしてVerilog HDL記述コードの生成
3. `make vvp` で `test_p32m2.vvp`を生成


### make の機能（シミュレーション）

4. `make mem` でシミュレーション時に用いるメモリイメージを作成
   （`maps version 2.0a (build 20E05) (2020-05-22)`以降が必要）
5. `make sim` でシミュレーション
6. `make diff` でシミュレーション結果と比較用結果ファイルを比較
シミュレーション結果の差分がない場合，下記の表示だけになります．

```
diff test_p32m2.result test_p32m2.result.sample || exit $(($? - 1))
```


### make の機能（mapsシミュレーション）

1. `make maps.sim` で動作確認用プログラム（`sum10.s`）を maps でシミュレーション

mapsでマルチサイクル版の動作（遅延スロットなし）をシミュレーションするには，
`--disable-delay-slot` オプションをつけてシミュレーションします．

maps でのソフトウェアシミュレーションと設計したプロセッサのハードウェアシミュレーションの結果を比較してみてください．


### make の機能（論理合成，配置配線，タイミング解析）

7. `make map` で FPGAへのマッピング
8. `make fit` で FPGAフィッティング
9. `make sta` で FPGAタイミング解析

マッピング，フィッティング等はサーバでの処理が重くなるため，実験用サーバ`jikken-a3`で行うようにしてください．


### make の機能（不要なファイルの消去）

1. `make clean` で掃除
2. `make distclean`で `.vvp`ファイルなども消去

Gitbucket に push する際には，不要なファイルを消去した後
（`make distclean`した後）に行うようにしてください．


### シミュレーション結果


```
VCD info: dumpfile test_p32m2.vcd opened for output.
         1: load...
        10: cpu start
        12: i_read: 00000000: 3c011000
        16: i_read: 00000004: 343c8000
        20: i_read: 00000008: 3c017fff
        .
        .
        .
        76: i_read: 00001044: afc40000
        79: S d_write: 7fffffd8: 1111 0000000a
        80: i_read: 00001048: 8fc20000
        83: S d_read: 7fffffd8:       0000000a
        85: i_read: 0000104c: 00000000
        .
        .
        .
      1069: cpu halted
 zero(0)  at(1)    v0(2)    v1(3)    a0(4)    a1(5)    a2(6)    a3(7)  
00000000 7fff0000 00000063 0000000a 00000000 00000037 00000000 00000000
 t0(8)    t1(9)    t2(10)   t3(11)   t4(12)   t5(13)   t6(14)   t7(15) 
00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 s0(16)   s1(17)   s2(18)   s3(19)   s4(20)   s5(21)   s6(22)   s7(23) 
00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 t8(24)   t9(25)   k0(26)   k1(27)   gp(28)   sp(29)   fp(30)   ra(31) 
00000000 00000000 00000000 00000000 10008000 7ffffffc 00000000 00000018
pc: 80000080  epc: 00000020  cause: 8
inst_count:         257
load_count:          55
store_count:         35
      1092: bye
```

* 一番左の数字は，シミュレーションサイクル
* サイクル 10 に cpu を起動（`cpu.start()`）
* `i_read: 命令アドレス 読み出した命令コード` ... 命令リード
* `S d_write: 書き込みアドレス: ロケーション 書き込む値` ... スタックセグメントへの書き込み
* `D d_write: 書き込みアドレス: ロケーション 書き込む値` ... データセグメントへの書き込み
* `S d_write: 書き込みアドレス: ロケーション 書き込む値` ... スタックセグメントへの書き込み
* `D d_read: 書き込みアドレス:      読み出した値` ... データセグメントからの読み出し
* `S d_read: 書き込みアドレス:      読み出した値` ... スタックセグメントからの読み出し
* `サイクル: cpu halted` ... cpu の 停止

停止後に，その時点でのレジスタ内容をダンプ（値は16進数）

* `inst_count:` ... プロセッサが読んだ命令数
* `load_count:` ... 実行したロード命令（`lw`, `lb`）の数
* `store_count:` ... 実行したストア命令（`sw`, `sb`）の数

詳細は，テストベンチのFSL記述（`test_p32m2.fsl`）を参照のこと．

---
